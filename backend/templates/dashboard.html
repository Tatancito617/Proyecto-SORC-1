<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SORC</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<div id="modalAgricultor" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('modalAgricultor')">&times;</span>
        <h2>Nuevo Agricultor</h2>
        <form action="/add/agricultor" method="POST" style="margin-top: 20px;">
            <div class="form-group"><label>Nombre</label><input name="nombre" class="form-control" required></div>
            <div class="form-group"><label>Apellido</label><input name="apellido" class="form-control" required></div>
            <div class="form-group"><label>Email</label><input type="email" name="email" class="form-control" required></div>
            <div class="form-group"><label>Ubicaci√≥n</label><input name="ubicacion" class="form-control" required></div>
            <button type="submit" class="iniciar-button" style="width:100%; padding:10px; font-size:1rem;">Guardar</button>
        </form>
    </div>
</div>

<div id="modalParcela" class="modal">
    <div class="modal-content" style="max-width: 700px;"> <span class="close-btn" onclick="closeModal('modalParcela')">&times;</span>
        <h2>Nueva Parcela üìç</h2>
        
        <form action="/add/parcela" method="POST" id="formParcela">
            <input type="hidden" name="agricultor_id" id="input_agri_id_parcela">
            
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label>Nombre Parcela</label>
                    <input name="nombre" class="form-control" required placeholder="Ej: Parcela Los R√≠os">
                </div>
                <div style="flex: 1;">
                    <label>Superficie (ha)</label>
                    <input type="number" step="0.1" name="superficie" class="form-control" required>
                </div>
            </div>

            <div style="margin-top: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 8px;">
                <label>üìç Ubicaci√≥n (Busca tu ciudad y haz clic en el mapa)</label>
                
                <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                    <input type="text" id="buscadorMapa" class="form-control" placeholder="Ej: Osorno, Chile">
                    <button type="button" class="btn--primary" onclick="buscarEnMapa()">üîç Buscar</button>
                </div>

                <div id="mapaSelector" style="height: 300px; width: 100%; border-radius: 4px;"></div>
                <small style="color: #666;">Haz clic en el lugar exacto de la parcela para guardar las coordenadas.</small>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <input name="latitud" id="input_lat" class="form-control" readonly placeholder="Latitud" required>
                <input name="longitud" id="input_lon" class="form-control" readonly placeholder="Longitud" required>
            </div>
            
            <button type="submit" class="iniciar-button" style="margin-top: 15px;">Guardar Parcela</button>
        </form>
    </div>
</div>

<div id="modalSensor" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('modalSensor')">&times;</span>
        <h2>Nuevo Sensor</h2>
        <form action="/add/sensor" method="POST" style="margin-top: 20px;">
            <div class="form-group"><label>ID Sensor (Chip ID)</label><input name="sensor_id" class="form-control" placeholder="Ej: ESP32_005" required></div>
            <div class="form-group"><label>Ubicaci√≥n</label><input name="ubicacion" class="form-control" placeholder="Ej: Sector Norte" required></div>
            <button type="submit" class="iniciar-button" style="width:100%; padding:10px; font-size:1rem;">Guardar</button>
        </form>
    </div>
</div>

<body>
    <div class="main-app">
        <aside class="sidebar">
            <div class="sidebar-logo">üå± SORC</div>
            <nav>
                <button class="nav-item active" data-view="dashboard">
                    <span style="font-size: 1.2rem;">üè†</span> 
                    <span>Inicio</span>
                </button>
                
                <button class="nav-item" data-view="agricultores">
                    <span style="font-size: 1.2rem;">üë®‚Äçüåæ</span>
                    <span>Agri</span>
                </button>
                
                <button class="nav-item" data-view="parcelas">
                    <span style="font-size: 1.2rem;">üåæ</span>
                    <span>Parcelas</span>
                </button>
                
                <button class="nav-item" data-view="sensores">
                    <span style="font-size: 1.2rem;">üì°</span>
                    <span>Sensores</span>
                </button>
                
                <button class="nav-item" data-view="lecturas">
                    <span style="font-size: 1.2rem;">üìä</span>
                    <span>Lecturas</span>
                </button>

            </nav>
        </aside>
        
        <main class="main-content">
            <header class="header">
                <div>Bienvenido, Administrador</div>
                <div id="currentDateTime"></div>
            </header>
            
            <div id="dashboard" class="view active">
                <h2>Resumen General</h2>
                <div class="dashboard-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-value">{{ n_agricultores }}</div>
                        <div class="stat-label">Agricultores</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ n_parcelas }}</div>
                        <div class="stat-label">Parcelas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ n_sensores }}</div>
                        <div class="stat-label">Sensores Activos</div>
                    </div>
                </div>
            </div>
<div id="agricultores" class="view">
                
                <div id="panel-lista-agricultores">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>üë®‚Äçüåæ Mis Clientes</h2>
                        <button class="btn--primary" onclick="openModal('modalAgricultor')">+ Nuevo Cliente</button>
                    </div>
                    
                    <div class="list-group">
                        {% for agri in agricultores %}
                        <div class="card card-hover" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="flex-grow: 1; cursor: pointer;" onclick="verParcelasDe('{{ agri.nombre }}', {{ agri.agricultor_id }})">
                                <h3>{{ agri.nombre }} {{ agri.apellido }}</h3>
                                <p style="color: #666; font-size: 0.9rem;">üìç {{ agri.ubicacion }}</p>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-icon warning" onclick="abrirEditarAgricultor({{ agri.agricultor_id }}, '{{ agri.nombre }}', '{{ agri.apellido }}', '{{ agri.ubicacion }}')">‚úèÔ∏è</button>
                                <button class="btn-icon danger" onclick="borrarAgricultor({{ agri.agricultor_id }})">üóëÔ∏è</button>
                            </div>
                        </div>
                        {% else %}
                        <p>No hay agricultores registrados.</p>
                        {% endfor %}
                    </div>
                </div>

                <div id="panel-lista-parcelas" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <button class="btn-back" onclick="mostrarNivel('agricultores')">‚¨Ö Volver</button>
                        <button class="btn--primary" onclick="openModal('modalParcela')">+ Nueva Parcela</button>
                    </div>
                    
                    <h2 id="titulo-cliente" style="margin-top: 10px;">Parcelas de...</h2>
                    
                    <div id="contenedor-parcelas" class="dashboard-grid"></div>
                </div>

                <div id="panel-detalle-parcela" style="display: none;">
                    <button class="btn-back" onclick="mostrarNivel('parcelas')">‚¨Ö Volver a Parcelas</button>
                    
                    <div class="card" style="margin-top: 15px; border-top: 5px solid var(--primary-green);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <h2 id="det-nombre-parcela">Parcela</h2>
                            <a id="btn-maps" href="#" target="_blank" class="btn--primary" style="background: #4285F4;">üó∫Ô∏è Ir con Maps</a>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <div class="weather-widget" style="flex:1; background:#3c3c3c; padding:10px; border-radius:8px; min-height: 120px;">
                                <h4>‚òÅÔ∏è Clima</h4>
                                <p>Cargando datos...</p>
                            </div>
                            <div style="flex:1; background:#fff3e0; padding:10px; border-radius:8px;">
                                <h4>üå± Suelo (Sensor)</h4>
                                <p>pH: <strong id="val-ph">--</strong></p>
                                <p>Humedad: <strong id="val-hum">--%</strong></p>
                                <p>Temp: <strong id="val-temp">--¬∞C</strong></p>
                            </div>
                        </div>

                        <div class="ai-section" style="margin-top: 20px;">
                            <h3>ü§ñ Recomendaci√≥n IA</h3>
                            <div id="ai-result" class="ai-box" style="display:none; padding: 10px; background: #f9f9f9; border-left: 4px solid gold; margin: 10px 0;"></div>
                            <button class="btn-ai btn--primary" style="width: 100%;" onclick="generarRecomendacion()">‚ú® Generar Diagn√≥stico</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="lecturas" class="view">
                <h2>√öltimas Lecturas de Sensores</h2>
                <div class="card" style="margin-top: 20px;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Sensor</th>
                                <th>Ubicaci√≥n</th>
                                <th>Temp</th>
                                <th>Humedad</th>
                                <th>pH</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dato in tabla_lecturas %}
                            <tr>
                                <td>{{ dato.sensor_id }}</td>
                                <td>{{ dato.ubicacion }}</td>
                                <td>{{ dato.temperatura }}¬∞C</td>
                                <td>{{ dato.humedad_suelo }}%</td>
                                <td>{{ dato.ph }}</td>
                                <td>{{ dato.fecha_registro }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6">No hay datos recientes.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div id="modalAgricultor" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('modalAgricultor')">&times;</span>
            <h2>Nuevo Agricultor</h2>
            <form action="/add/agricultor" method="POST" style="margin-top: 15px;">
                <div class="form-group"><label>Nombre</label><input name="nombre" class="form-control" required></div>
                <div class="form-group"><label>Apellido</label><input name="apellido" class="form-control" required></div>
                <div class="form-group"><label>Email</label><input name="email" type="email" class="form-control" required></div>
                <div class="form-group"><label>Ubicaci√≥n</label><input name="ubicacion" class="form-control" required></div>
                <button type="submit" class="iniciar-button" style="width: 100%; margin-top: 10px;">Guardar</button>
            </form>
        </div>
    </div>

    <div id="modalEditarAgricultor" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('modalEditarAgricultor')">&times;</span>
            <h2>Editar Agricultor</h2>
            <form action="/edit/agricultor" method="POST" style="margin-top: 15px;">
                <input type="hidden" name="agricultor_id" id="edit_agri_id">
                <div class="form-group"><label>Nombre</label><input name="nombre" id="edit_agri_nombre" class="form-control"></div>
                <div class="form-group"><label>Apellido</label><input name="apellido" id="edit_agri_apellido" class="form-control"></div>
                <div class="form-group"><label>Ubicaci√≥n</label><input name="ubicacion" id="edit_agri_ubicacion" class="form-control"></div>
                <button type="submit" class="iniciar-button" style="width: 100%; margin-top: 10px;">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <div id="modalEditarParcela" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('modalEditarParcela')">&times;</span>
            <h2>Editar Parcela</h2>
            <form action="/edit/parcela" method="POST" style="margin-top: 15px;">
                <input type="hidden" name="parcela_id" id="edit_parcela_id">
                
                <div class="form-group"><label>Nombre</label><input name="nombre" id="edit_parcela_nombre" class="form-control" required></div>
                <div class="form-group"><label>Superficie (ha)</label><input type="number" step="0.1" name="superficie" id="edit_parcela_superficie" class="form-control"></div>
                <div class="form-group"><label>Latitud</label><input name="latitud" id="edit_parcela_lat" type="number" step="any" class="form-control"></div>
                <div class="form-group"><label>Longitud</label><input name="longitud" id="edit_parcela_lon" type="number" step="any" class="form-control"></div>
                
                <button type="submit" class="iniciar-button" style="width: 100%; margin-top: 10px;">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

</body>
</html>